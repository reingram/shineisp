<?php

/**
 * Files
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ShineISP
 * 
 * @author     Shine Software <info@shineisp.com>
 * @version    SVN: $Id: Builder.php 6820 2009-11-30 17:27:49Z jwage $
 */
class Files extends BaseFiles {
	
	/**
	 * Save the file information in the database
	 * @param string $filepath
	 * @param string $attachedto
	 * @param integer $id
	 * @param integer $categoryID (default 3 - Documents)
	 */
	public static function saveit($filename, $path, $attachedto, $id, $categoryID=3) {
		$file = new Files();
		$file->file = $filename;
		$file->path = $path;
		$file->attachedto = $attachedto;
		$file->publickey = Shineisp_Commons_Uuid::generate();
		$file->id = $id;
		$file->date = date('Y-m-d H:i:s');
		$file->ip = $_SERVER['REMOTE_ADDR'];
		$file->category_id = $categoryID;
		
		if($file->trySave()){
			return $path . $filename;
		}
		
		return false;
	}
	
	/**
	 * Update the download counter
	 * @param integer $id
	 */
	public static function updateDownloadCounter($id){
	    Doctrine_Query::create()->update("Files")->set('download', 'download + 1')->where("file_id = ?", $id)->execute();
	    Doctrine_Query::create()->update("Files")->set('lastdownload', '?', date('Y-m-d h:i:s'))->where("file_id = ?", $id)->execute();
	}
	
	/**
	 * find
	 * Get a record by ID
	 * @param $id
	 * @return Doctrine Record
	 */
	public static function find($id) {
		return Doctrine::getTable ( 'Files' )->find ($id );
	}
	
	/**
	 * Get a file by its id
	 * @param $id
	 * @return array
	 */
	public static function get_by_id($id) {
		$file = Doctrine_Query::create ()->from( 'Files' )
									   	   ->where ( "file_id = ?", $id )
									   	   ->limit(1)
									       ->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
		
		return !empty($file[0]) ? $file[0] : array();
	}
	
	/**
	 * Get a file by its public key
	 * @param $key
	 * @return array
	 */
	public static function get_by_publickey($key) {
		$file = Doctrine_Query::create ()->from( 'Files' )
									   	   ->where ( "publickey = ?", $key )
									   	   ->limit(1)
									       ->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
		
		if(!empty($file[0])){
		    self::updateDownloadCounter($file[0]['file_id']);
		    return $file[0];
		}
		
		return array();
	}
	
	/**
	 * Download the file
	 * @param string $key
	 */
	public static function downloadbykey($key){
	    if (empty($key)){
	        return false;
	    }
	    
	    $file = Files::get_by_publickey($key);
	     
	    if(!empty($file)){
	        $uri = PUBLIC_PATH . $file['path'] . $file['file'];
	    
	        if (!empty($uri) && file_exists($uri)) {
	            header('Content-Description: File Transfer');
	            header('Content-Type: application/octet-stream');
	            header('Content-Disposition: attachment; filename='.basename($uri));
	            header('Content-Transfer-Encoding: binary');
	            header('Expires: 0');
	            header('Cache-Control: must-revalidate');
	            header('Pragma: public');
	            header('Content-Length: ' . filesize($uri));
	            ob_clean();
	            flush();
	            readfile($uri);
	            exit;
	        }
	    }
	    return false;
	}
	
	/**
	 * Delete the file
	 * @param $id
	 * @return boolean
	 */
	public static function del($id) {
		$file = Doctrine_Query::create ()->from( 'Files' )
									   	   ->where ( "file_id = ?", $id )
									       ->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
		// Delete the file
		if(!empty($file[0])){
			@unlink(PUBLIC_PATH . $file[0]['path'] . "/" . $file[0]['file']);
		}	
		
		// Delete the record
		Doctrine::getTable ( 'Files' )->findOneBy ( 'file_id', $id )->delete();
		return true;
	}
	
	/**
	 * Delete all the files of a customer
	 * @param $id
	 * @return boolean
	 */
	public static function delete_all_by_customerId($id) {
		
		$files = Doctrine_Query::create ()->from( 'Files' )
									   	   ->where ( "id = ?", $id )
									   	   ->addWhere ( "attachedto = ?", 'customers' )
									       ->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );

		// Delete all the files and record
		foreach($files as $file){
			@unlink(PUBLIC_PATH . $file['path'] . "/" . $file['file']);
			
			// Delete the record
			Doctrine::getTable ( 'Files' )->findOneBy ( 'file_id', $file['file_id'] )->delete();
		}	
									       
		return true;
	}
	
	/**
	 * findbyExternalId
	 * Get a record by the external ID
	 * @param $id, $attachedto [orders, customers], $fields="*"
	 * @return Doctrine Record
	 */
	public static function findbyExternalId($id, $attachedto, $fields="*") {
		
		return Doctrine_Query::create ()->select($fields)
									   	->from( 'Files f' )
									   	->leftJoin('f.FilesCategories fc')
									   	->where ( "f.id = ?", $id )
									    ->andWhere ( "attachedto = ?", $attachedto )
									    ->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
										
	}

}