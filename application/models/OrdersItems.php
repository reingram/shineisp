<?php

/**
 * OrdersItems
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ShineISP
 * 
 * @author     Shine Software <info@shineisp.com>
 * @version    SVN: $Id: Builder.php 6820 2009-11-30 17:27:49Z jwage $
 */
class OrdersItems extends BaseOrdersItems {
	

	/**
	 * grid
	 * create the configuration of the grid
	 */	
	public static function grid($rowNum = 10) {
		$ns = new Zend_Session_Namespace ();
		$translator = Shineisp_Registry::getInstance ()->Zend_Translate;
		
		$config ['datagrid'] ['columns'] [] = array ('label' => null, 'field' => 'd.detail_id', 'alias' => 'id', 'type' => 'selectall' );
		$config ['datagrid'] ['columns'] [] = array ('label' => $translator->translate ( 'ID' ), 'field' => 'd.detail_id', 'alias' => 'id', 'sortable' => true, 'searchable' => true, 'type' => 'string' );
		$config ['datagrid'] ['columns'] [] = array ('label' => $translator->translate ( 'Order ID' ), 'field' => 'o.order_id', 'alias' => 'order_id', 'sortable' => true, 'searchable' => true, 'type' => 'string', 'attributes' => array('class' => 'visible-lg visible-md hidden-xs') );
		$config ['datagrid'] ['columns'] [] = array ('label' => $translator->translate ( 'Type' ), 'field' => 'p.type', 'alias' => 'type', 'sortable' => true, 'searchable' => true, 'type' => 'string' );
		$config ['datagrid'] ['columns'] [] = array ('label' => $translator->translate ( 'Service' ), 'field' => 'pd.name', 'alias' => 'productname', 'sortable' => true, 'searchable' => true, 'type' => 'link', 'link' => array('idx' => 'product_id', 'href' => '/admin/products/edit/id/%s') );
		$config ['datagrid'] ['columns'] [] = array ('label' => $translator->translate ( 'Domain' ), 'field' => 'dm.domain', 'alias' => 'domain', 'sortable' => true, 'searchable' => true, 'type' => 'string', 'attributes' => array('class' => 'visible-lg visible-md hidden-xs') );
		$config ['datagrid'] ['columns'] [] = array ('label' => $translator->translate ( 'Company' ), 'field' => 'c.company', 'alias' => 'company', 'sortable' => true, 'searchable' => true, 'type' => 'link', 'link' => array('idx' => 'customer_id', 'href' => '/admin/customers/edit/id/%s'), 'attributes' => array('class' => 'visible-lg visible-md hidden-xs') );
		$config ['datagrid'] ['columns'] [] = array ('label' => $translator->translate ( 'Last name' ), 'field' => 'c.lastname', 'alias' => 'lastname', 'sortable' => true, 'searchable' => true, 'type' => 'link', 'link' => array('idx' => 'customer_id', 'href' => '/admin/customers/edit/id/%s'), 'attributes' => array('class' => 'visible-lg visible-md hidden-xs') );
		$config ['datagrid'] ['columns'] [] = array ('label' => $translator->translate ( 'Days left' ), 'field' => 'd.date_end', 'alias' => 'daysleft', 'sortable' => true, 'searchable' => false, 'type' => 'integer', 'attributes' => array('class' => 'visible-lg visible-md hidden-xs') );
		$config ['datagrid'] ['columns'] [] = array ('label' => $translator->translate ( 'Start date' ), 'field' => 'd.date_start', 'alias' => 'date_start', 'sortable' => true, 'searchable' => true, 'type' => 'date', 'attributes' => array('class' => 'visible-lg visible-md hidden-xs') );
		$config ['datagrid'] ['columns'] [] = array ('label' => $translator->translate ( 'End date' ), 'field' => 'd.date_end', 'alias' => 'date_end', 'sortable' => true, 'searchable' => true, 'type' => 'date', 'attributes' => array('class' => 'visible-lg visible-md hidden-xs') );
		$config ['datagrid'] ['columns'] [] = array ('label' => $translator->translate ( 'Statuses' ), 'field' => 's.status', 'filterdata' => Statuses::getList('services'), 'type'=>'index', 'alias' => 'status', 'sortable' => true, 'searchable' => true, 'attributes' => array('class' => 'visible-lg visible-md hidden-xs'));
		
		$config ['datagrid'] ['fields'] =  "d.detail_id as id,
											o.order_number as order_id, 
											p.product_id as product_id, 
											c.customer_id as customer_id, 
											c.company as company, 
											c.lastname as lastname,
											d.order_id, 
											DATE_FORMAT(d.date_start, '".Settings::getMySQLDateFormat('dateformat')."') as date_start, 
											DATE_FORMAT(d.date_end, '".Settings::getMySQLDateFormat('dateformat')."') as date_end, 
											pd.name as productname, 
											p.type as type, 
											s.status as status, 
											oid.relationship_id as oid,
											dm.domain_id as domain_id,
											DATEDIFF(d.date_end, CURRENT_DATE) as daysleft, 
											CONCAT(dm.domain, '.', ws.tld ) as domain,
											bc.name as cycle";
		
		$config ['datagrid'] ['rownum'] = $rowNum;
		
        $dq = Doctrine_Query::create ()->select ( $config ['datagrid'] ['fields'] )->from ( 'OrdersItems d' )
                    ->leftJoin ( 'd.Orders o' )
                    ->leftJoin ( 'd.OrdersItemsDomains oid ON d.detail_id = oid.orderitem_id' )
                    ->leftJoin ( 'd.BillingCycle bc' )
                    ->leftJoin ( 'oid.Domains dm' )
                    ->leftJoin ( 'dm.DomainsTlds dt' )
                    ->leftJoin ( 'dt.WhoisServers ws' )
                    ->leftJoin ( 'd.Products p' )
                    ->leftJoin ( "p.ProductsData pd WITH pd.language_id = $ns->idlang" )
                    ->leftJoin ( 'p.Taxes t' )->leftJoin ( 'o.Customers c' )
                    ->leftJoin ( 'd.Statuses s' )
                    ->where ( 'p.type <> ?', 'domain') // Show all the records but not the Expired services // Show only the services and not the domains
        			->andWhere('o.isp_id = ?', Shineisp_Registry::get('ISP')->isp_id);
        
		$config ['datagrid'] ['dqrecordset'] = $dq;
		
		$config ['datagrid'] ['basepath'] = "/admin/services/";
		$config ['datagrid'] ['index'] = "detail_id";
		$config ['datagrid'] ['rowlist'] = array ('10', '50', '100', '1000' );
		
		$config ['datagrid'] ['buttons'] ['edit'] ['label'] = $translator->translate ( 'Edit' );
		$config ['datagrid'] ['buttons'] ['edit'] ['cssicon'] = "edit";
		$config ['datagrid'] ['buttons'] ['edit'] ['action'] = "/admin/services/edit/id/%d";
		
		$config ['datagrid'] ['buttons'] ['delete'] ['label'] = $translator->translate ( 'Delete' );
		$config ['datagrid'] ['buttons'] ['delete'] ['cssicon'] = "delete";
		$config ['datagrid'] ['buttons'] ['delete'] ['action'] = "/admin/services/delete/id/%d";
		$config ['datagrid'] ['massactions']['common'] = array ('massdelete'=>'Mass Delete', 'bulkexport'=>'Export' );
		
		$customacts = array();
		$actions = Panels::getActions ();
		if(!empty($actions))
    		foreach ($actions as $registrar => $tasks) {
    		    foreach ($tasks as $action => $label) {
        		    $customacts['bulk_registrar_tasks&task=' . $action ] = $translator->_('%s registrar task: %s', $registrar, $label);
        		}
    		}
    		
		$config ['datagrid'] ['massactions']['panels'] = $customacts;
		
		return $config;
	}
	

	
	/**
	 * findAll
	 * Get records the orders from the DB
	 * @param $currentPage
	 * @param $rowNum
	 * @param $sort
	 * @param $where
	 * @return array
	 */
	public static function findAll($fields = "*", $currentPage = 1, $rowNum = 2, array $sort = array(), array $where = array(), $locale=1) {
		
		$module = Zend_Controller_Front::getInstance ()->getRequest ()->getModuleName ();
		$controller = Zend_Controller_Front::getInstance ()->getRequest ()->getControllerName ();
		
		try {
			// Defining the url sort
			$uri = isset ( $sort [1] ) ? "/sort/$sort[1]" : "";
			$dq = Doctrine_Query::create ()->select ( $fields )->from ( 'OrdersItems d' )
					->leftJoin ( 'd.Orders o' )
					->leftJoin ( 'd.OrdersItemsDomains oid ON d.detail_id = oid.orderitem_id' )
					->leftJoin ( 'd.BillingCycle bc' )
					->leftJoin ( 'oid.Domains dm' )
					->leftJoin ( 'dm.DomainsTlds dt' )
					->leftJoin ( 'dt.WhoisServers ws' )
					->leftJoin ( 'd.Products p' )
					->leftJoin ( "p.ProductsData pd WITH pd.language_id = $locale" )
					->leftJoin ( 'p.Taxes t' )
					->leftJoin ( 'o.Customers c' )
					->leftJoin ( 'd.Statuses s' )
					->where ( 'p.type <> ?', 'domain'); // Show all the records but not the Expired services // Show only the services and not the domains
			

			$pagerLayout = new Doctrine_Pager_Layout ( new Doctrine_Pager ( $dq, $currentPage, $rowNum ), new Doctrine_Pager_Range_Sliding ( array ('chunk' => 10 ) ), "/$module/$controller/list/page/{%page_number}" . $uri );
			
			// Get the pager object
			$pager = $pagerLayout->getPager ();
			
			// Set the Order criteria
			if (isset ( $sort [0] )) {
				$pager->getQuery ()->orderBy ( $sort [0] );
			}
			
			if (isset ( $where ) && is_array ( $where )) {
				foreach ( $where as $filters ) {
					if (isset ( $filters [0] ) && is_array($filters [0])) {
						foreach ( $filters as $filter ) {
							$method = $filter ['method'];
							$value = $filter ['value'];
							$criteria = $filter ['criteria'];
							$pager->getQuery ()->$method ( $criteria, $value );
						}
					} else {
						$method = $filters ['method'];
						$value = $filters ['value'];
						$criteria = $filters ['criteria'];
						$pager->getQuery ()->$method ( $criteria, $value );
					}
				}
			}

			$pagerLayout->setTemplate ( '<a href="{%url}">{%page}</a> ' );
			$pagerLayout->setSelectedTemplate ( '<a class="active" href="{%url}">{%page}</a> ' );
			$records = $pagerLayout->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
			$pagination = $pagerLayout->display ( null, true );
			
			return array ('records' => $records, 'pagination' => $pagination, 'pager' => $pager, 'recordcount' => $dq->count () );
		} catch ( Exception $e ) {
			die ( $e->getMessage () );
		}
	}	
		

	/**
	 * getExpiringServicesByDays
	 * Get all the services from the order details bought by the customers
	 * @param integer $days
	 * @param integer $status
	 * @param integer $autorenew [0, 1]
	 */
    public static function getExpiringServicesByDays($days=0, $status=null, $autorenew=null) {
        $dq = Doctrine_Query::create ()->select ( "oi.detail_id, 
        										   pd.name as product,
        										   c.customer_id as id, 
        										   oi.date_end as expiringdate, 
        										   oi.date_start as startingdate, 
        										   oi.description as description, 
        										   DATEDIFF(oi.date_end, CURRENT_DATE) as daystoend,
        										   o.customer_id as customer_id,
        										   Concat(c.firstname, ' ', c.lastname, ' ', c.company) as fullname, 
        										   c.email as email, 
        										   c.language_id as language_id, 
        										   c.password as password,
        										   c.parent_id as reseller, 
        										   oi.autorenew as renew,
        										   DATEDIFF(oi.date_end, CURRENT_DATE) as days" )
                                           ->from ( 'OrdersItems oi' )
                                           ->leftJoin ( 'oi.Orders o' )
                                           ->leftJoin ( 'oi.Products p' )
                                           ->leftJoin ( 'oi.BillingCycle bc' )
                                           ->leftJoin ( "p.ProductsData pd WITH pd.language_id = 1" )
                                           ->leftJoin ( 'o.Customers c' )
                                           ->where ( 'p.type <> ?', 'domain') // get all the services
        								   ->addWhere('bc.months > ?', 0);  // get the recurring services only

        if(is_numeric($days)){
        	$dq->andWhere ( 'DATEDIFF(oi.date_end, CURRENT_DATE) = ?', $days );
        }
        
        if(is_numeric($status)){
        	$dq->andWhere ( 'oi.status_id = ?', $status );  
        }else{
        	$dq->andWhere ( 'oi.status_id = ?', Statuses::id("complete", "orders") ); 
        }
        
        if(is_numeric($autorenew)){
        	$dq->andWhere ( 'oi.autorenew = ?', $autorenew );  
        }

        $dq->orderBy('oi.date_end asc');
        $records = $dq->execute ( null, Doctrine::HYDRATE_ARRAY );
//         Zend_Debug::dump($records);
//         die;
        return $records;
            
    }
		

    /**
     * Get all the services from the order details bought by the customers and by days range
     * @param integer $from [0 days]
     * @param integer $to [30 days]
     * @param integer $status
     * @param integer $autorenew [0, 1]
     */
    public static function getExpiringServicesByRange($from=null, $to=null, $status=null, $autorenew=null, array $types = array(), array $attributegrpcode = array()) {
    	$currency   = Shineisp_Registry::getInstance ()->Zend_Currency;
    	
    	try{
	    	$dq = Doctrine_Query::create ()->select ( "oi.detail_id, oi.price as price, oid.relationship_id,
	        										   pd.name as product,
	        										   c.customer_id as id, 
	        										   DATE_FORMAT(oi.date_end, '".Settings::getMySQLDateFormat('dateformat')."') as expiringdate,
	        										   o.customer_id as customer_id,
	        										   c.language_id as language_id,
	        										   Concat(c.firstname, ' ', c.lastname, ' ', c.company) as fullname, 
	        										   c.email as email, 
	        										   c.password as password,
	        										   c.parent_id as reseller, 
	        										   oi.autorenew as renew,
	    	                                           p.product_id as product_id,
	    	                                           p.type as type,
	    											   d.domain as domain_id,
	    											   CONCAT(d.domain, '.', ws.tld) as domain, 
	        										   DATEDIFF(oi.date_end, CURRENT_DATE) as days" )
	                                           ->from ( 'OrdersItems oi' )
	                                           ->leftJoin ( 'oi.Orders o' )
	                                           ->leftJoin ( 'oi.OrdersItemsDomains oid' )
	                                           ->leftJoin ( 'oid.Domains d' )
	                                           ->leftJoin ( 'd.DomainsTlds dt' )
	                                           ->leftJoin ( 'dt.WhoisServers ws' )
	                                           ->leftJoin ( 'oi.Products p' )
	                                           ->leftJoin ( 'p.ProductsAttributesGroups pag' )
	                                           ->leftJoin ( "p.ProductsData pd WITH pd.language_id = 1" )
	                                           ->leftJoin ( 'o.Customers c' );
	                                           
	        if(!empty($types)){
	        	$dq->andWhereIn('p.type', $types);
	        }else{
	        	$dq->where ( 'p.type <> ?', 'domain');
	        }
	        
	        if(!empty($attributegrpcode)){
	        	$dq->andWhereIn('pag.code', $attributegrpcode);
	        }
	        
	    	if(!is_null($from) && !is_null($to)){
	    		$dq->andWhere ( 'DATEDIFF(oi.date_end, CURRENT_DATE) >= ? and DATEDIFF(oi.date_end, CURRENT_DATE) <= ?', array($from, $to) );
	    	}
	    	
	        if(is_numeric($status)){
	        	$dq->andWhere ( 'oi.status_id = ?', $status );  
	        }else{
	        	$dq->andWhere ( 'oi.status_id = ?', Statuses::id("complete", "orders") );
	        }
	        
	        if(is_numeric($autorenew)){
	        	$dq->andWhere ( 'oi.autorenew = ?', $autorenew );  
	        }
	        
	        $dq->orderBy('oi.date_end asc');
	        
	        $records = $dq->execute ( null, Doctrine::HYDRATE_ARRAY );
	        
	        for($i=0;$i<count($records);$i++){
	        	$records[$i]['price'] = $currency->toCurrency($records[$i]['price'], array('currency' => Settings::findbyParam('currency')));
	        }
	        
	        return $records;
	        
    	}catch (Exception $e){
    		die($e->getMessage());
    		
    	}
            
    }
	
	/**
	 * getItemsList
	 * Get a list of all items in all the orders by description
	 * @param $description
	 * @return array
	 */
	public static function getItemsListbyDescription($description) {
		$items = array ();
		if (! empty ( $description )) {
			$registry = Shineisp_Registry::getInstance ();
			$translations = $registry->Zend_Translate;
			
			$dq = Doctrine_Query::create ()->select ( "oi.detail_id, o.order_id as order_id, s.status as status, DATE_FORMAT(order_date, '".Settings::getMySQLDateFormat('dateformat')."') as orderdate, oi.description as description" )->from ( 'OrdersItems oi' )->leftJoin ( 'oi.Orders o' )->leftJoin ( 'o.Statuses s' )->where ( 'oi.description like ?', "%" . $description . "%" );
			$retval = $dq->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
			foreach ( $retval as $c ) {
				$description = $c ['description'];
				$description = str_replace ( "\n", "", $description );
				$items [$c ['order_id']] = $c ['order_id'] . " - " . $c ['orderdate'] . " - " . $description . " - [" . $c['status']. "] ";
			}
		}
		
		return $items;
	}
	
	/**
	 * setStatus
	 * Set a record with a status
	 * @param $id, $status
	 * @return Void
	 */
	public static function set_status($id, $status) {
	    Shineisp_Commons_Utilities::log("Set status of ".$id." => ".print_r($status,true),"api.log");
		$dq = Doctrine_Query::create ()->update ( 'OrdersItems oi' )->set ( 'status_id', $status )->where ( "detail_id = ?", $id );
		return $dq->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
	}
	
	/**
	 * setAutorenew
	 * Set the autorenew for the record selected 
	 * @param $id
	 * @return Boolean
	 */
	public static function setAutorenew($id, $value=1) {
		return Doctrine_Query::create ()
						->update ( 'OrdersItems oi' )
						->set ( 'autorenew', $value )
						->where ( "detail_id = ?", $id )
						->execute ();
	}
	
	/**
	 * Update the product system parameters of the service by service id (detail_id)
	 * 
	 * Parameters sample array 
	 * =======================
	 * 
	 *  array(5) {
	 *	  ["webspace"] => string(3) "500"
	 *	  ["trafficdata"] => string(4) "1000"
	 *	  ["emails"] => string(1) "5"
	 *	  ["databases"] => string(1) "1"
	 *	  ["mailalias"] => string(4) "1000"
	 *	}
	 *  
	 * @param $detail_id
	 * @param $parameters 
	 * @return Boolean
	 */
	public static function updateSysParameters($detail_id, array $parameters) {
		if(is_numeric($detail_id) && !empty($parameters)){
			$oi = Doctrine::getTable ( 'OrdersItems' )->find ( $detail_id );
			$oi['parameters'] = json_encode($parameters);
			$oi->save();
			return true;
		}
		return false;
	}
	
	/**
	 * saveAll
	 * Save all the data 
	 * @param $params
	 * @return Boolean
	 */
	public static function saveAll($id, $params) {
		$date_end = null;
		
		if(!is_array($params))
			return false;
		
		$details = Doctrine::getTable ( 'OrdersItems' )->find ( $id );
		
		// Generic price setting 
		$rowtotal = $params ['price'];
		$vat = null;
		$percentage = null;
	
		// Get the taxes applied
		$tax = Taxes::getTaxbyProductID($params['product_id']);
		if ($tax['percentage'] > 0) {
			$rowtotal = $params ['price'] * (100 + $tax['percentage']) / 100;
			$vat = ($params ['price'] * $tax['percentage']) / 100;
			$percentage = $tax['percentage'];
		} else {
			if(!empty($params['parameters'])){ // it is a domain
				$domainparams = json_decode ( $params ['parameters'], true );

				if (! empty ( $domainparams['domain'] ['tld'] )) {
					$tax = Taxes::getTaxbyTldID($domainparams ['domain']['tld']);
					
					if ($tax['percentage'] > 0) {
						$vat = ($params ['price'] * $tax['percentage']) / 100;
						$percentage = $tax['percentage'];
						$rowtotal = $params ['price'] * (100 + $tax['percentage']) / 100;
					}
				}
			}
		}
		
	    if(!empty($params['billing_cycle_id']))
		    $months = BillingCycle::getMonthsNumber ( $params ['billing_cycle_id'] );
		    if ($months > 0 && is_numeric($params ['product_id']) && $params ['product_id'] > 0) // only for the product and services. Domains excluded
		        $rowtotal = $rowtotal * $months;
		        $params ['date_end'] = Shineisp_Commons_Utilities::add_date ( $params ['date_start'], null, $months );
		
		$details->quantity         = $params ['quantity'];
		$details->date_start       = Shineisp_Commons_Utilities::formatDateIn ( $params ['date_start'] );
		$details->date_end         = Shineisp_Commons_Utilities::formatDateIn($params ['date_end']);
		$details->billing_cycle_id = !empty($params['billing_cycle_id']) ? $params ['billing_cycle_id'] : null;
		$details->price            = $params ['price'];
		$details->vat              = $vat;
		$details->percentage       = $percentage;
		$details->cost             = $params ['cost'];
		$details->product_id       = is_numeric($params ['product_id']) && $params ['product_id'] > 0 ? $params ['product_id'] : NULL;
		$details->setupfee         = $params ['setupfee'];
		$details->discount         = $params ['discount'];
		$details->subtotal         = $rowtotal * $params ['quantity'];
		$details->status_id        = $params ['status_id'];
		$details->description      = $params ['description'];
		$details->parameters       = $params ['parameters'];
		
		if($details->trySave ()){
			OrdersItems::setAutorenew($id, $params ['autorenew']);

			// Remove all domains
			OrdersItemsDomains::removeAllDomains($id);
			if ($params ['domains_selected']) {
				foreach ( $params ['domains_selected'] as $domain ) {
					OrdersItemsDomains::addDomain($details ['order_id'], $domain);
				}
			}
			
			return true;
		}
		
		return false;
	}
	
	/**
	 * setNewStatus
	 * Set the status in a group of records
	 * @param $orderid, $status
	 * @return Void
	 */
	public static function setNewStatus($orderid, $status) {
		
		$dq = Doctrine_Query::create ()->update ( 'OrdersItems oi' )->set ( 'status_id', $status )->where ( "order_id = ?", $orderid );
		return $dq->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
	}
	
	/**
	 * Get the product bought by the customer in the orderitems
	 * @param $detail_id
	 * @param $locale
	 * @return ArrayObject
	 */
	public static function getDetail($detail_id, $locale=1) {
		
		$record = Doctrine_Query::create ()->from ( 'OrdersItems oi' )
										   ->leftJoin ( 'oi.Products p' )
										   ->leftJoin ( "p.ProductsData pd WITH pd.language_id = $locale" )
										   ->where ( "detail_id = ?", $detail_id )
										   ->limit ( 1 )
										   ->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
										   
		return !empty($record[0]) ? $record[0] : array();
	}
	
	/**
	 * getAllInfo
	 * Get all data starting from the detail ID 
	 * @param $id
	 * @return Doctrine Record / Array
	 */
	public static function getAllInfo($id, $fields = "*", $where = "", $locale=1) {
		
		try {
			$dq = Doctrine_Query::create ()->from ( 'OrdersItems oi' )
										   ->leftJoin ( 'oi.Orders o' )
										   ->leftJoin ( 'o.OrdersItemsDomains oid' )
										   ->leftJoin ( 'oid.Domains d' )
										   ->leftJoin ( 'd.DomainsTlds dt' )
										   ->leftJoin ( 'dt.WhoisServers ws' )
										   ->leftJoin ( 'dt.DomainsTldsData dtd' )
										   ->leftJoin ( 'dt.Taxes tax' )
										   ->leftJoin ( 'o.Customers c' )
										   ->leftJoin ( 'oi.Statuses s' )
										   ->leftJoin ( 'oi.Products p' )
										   ->leftJoin ( 'p.ProductsAttributesGroups pag' )
										   ->leftJoin ( 'pag.ProductsAttributesGroupsIndexes pagi' )
										   ->leftJoin ( 'p.ProductsAttributesIndexes pai' )
										   ->leftJoin ( 'pai.ProductsAttributes pa' )
										   ->leftJoin ( "p.ProductsData pd WITH pd.language_id = $locale" )
										   ->leftJoin ( 'p.Taxes t' )
										   ->leftJoin ( 'oi.BillingCycle bc' )
										   ->where ( "detail_id = ?", $id )
										   ->limit ( 1 );
			
			if(!empty($fields) && $fields != "*"){
				$dq->select ( $fields );
			}							   
										   
			if ($where) {
				$dq->andWhere ( $where );
			}
			
			$items = $dq->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
			
		} catch ( Exception $e ) {
			die ( $e->getMessage () );
		}
		
		return !empty($items[0]) ? $items[0] : array();
	}
	
	/**
	 * find
	 * Get a record by ID
	 * @param $id
	 * @return Doctrine Record
	 */
	public static function find($id, $fields = "*", $retarray = false) {
		
		if(!is_numeric($id)){
			return null;
		}
		
		$dq = Doctrine_Query::create ()->select ( $fields )
										->from ( 'OrdersItems oi' )
										->where ( "detail_id = ?", $id )
										->limit ( 1 );
		
		$retarray = $retarray ? Doctrine_Core::HYDRATE_ARRAY : null;
		$item = $dq->execute ( array (), $retarray );
		return $item;
	}
	
	/**
	 * getAllDetails
	 * Get all Details starting from the orderID 
	 * @param $id
	 * @return Doctrine Record / Array
	 */
	public static function getAllDetails($id, $fields = "*", $retarray = false) {
		
		$dq = Doctrine_Query::create ()->select ( $fields )->from ( 'OrdersItems oi' )
										->leftJoin ( 'oi.Orders o' )
										->leftJoin ( 'oi.DomainsTlds dt' )
									    ->leftJoin ( 'dt.DomainsTldsData dtd' )
									    ->leftJoin ( 'dt.Taxes tax' )
										->leftJoin ( 'o.Customers c' )
										->leftJoin ( 'oi.Statuses s' )
										->leftJoin ( 'oi.Products p' )
										->leftJoin ( 'oi.BillingCycle bc' )
										->where ( "order_id = ?", $id );
		
		$retarray = $retarray ? Doctrine_Core::HYDRATE_ARRAY : null;
		$items = $dq->execute ( array (), $retarray );
		
		return $items;
	}
	
	/**
	 * Get all activable items starting from the orderID
	 *  
	 * @param $id
	 * @return Doctrine Record / Array
	 */
	public static function getAllActivableItems($id, $fields = "*, p.type", $retarray = false) {
		$dq = Doctrine_Query::create ()->select ( $fields )->from ( 'OrdersItems oi' )
		->leftJoin ( 'oi.Products p' )
		->where ( "order_id = ?", $id )
		->andWhere ( "p.type = 'hosting' OR p.type = 'domain' OR oi.tld_id > 0 ")
		->andWhere ( "oi.status_id != ?", Statuses::id('complete','orders')); // !Complete

		$retarray = $retarray ? Doctrine_Core::HYDRATE_ARRAY : null;
		$items = $dq->execute ( array (), $retarray );
		
		return $items;
	}
	
	
	/**
	 * Get the setup information of a particular service 
	 * 
	 * @param integer $itemid
	 */
	public static function getSetupConfig($itemid){
		if(is_numeric($itemid)){
			$dq = Doctrine_Query::create ()->select ( "setup" )->from ( 'OrdersItems oi' )->where ( "detail_id = ?", $itemid )->limit(1);
			
			$records = $dq->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
			return !empty($records[0]['setup']) ? json_decode($records[0]['setup'], true) : array();
		}
		return false;
	}
	
	
	/**
	 * getAllRecurringServices
	 * Get all Services subscribed by the customers 
	 * @param $fields, $retarray
	 * @return Doctrine Record / Array
	 */
	public static function getAllRecurringServices($fields="*", $productgroups = array(), $locale=1) {
		
		$items = Doctrine_Query::create ()
						->from ( 'OrdersItems oi' )
						->leftJoin ( 'oi.BillingCycle bc' )
						->leftJoin ( 'oi.Orders o' )
						->leftJoin ( 'o.Customers c' )
						->leftJoin ( 'oi.Products p' )
						->leftJoin ( 'p.ProductsAttributesGroups pag' )
						->leftJoin ( 'oi.OrdersItemsDomains oid' )
						->leftJoin ( 'oid.Domains d' )
						->leftJoin ( 'd.DomainsTlds dt' )
						->leftJoin ( 'dt.WhoisServers ws' )
						->leftJoin ( "p.ProductsData pd WITH pd.language_id = $locale" )
						->where ( "pag.isrecurring = ?", 1)
						->andWhere ( "oi.status_id = ?", Statuses::id("complete", "orders") )	// with status "Complete"
						->orderBy('YEAR(oi.date_end), MONTH(oi.date_end)')
						->limit(10);
						
		if($fields != "*"){
			$items->select ($fields);
		}				
			// select a group of product				
		if(count($productgroups)>0){
			foreach ($productgroups as $group_id){
				$groups[] = "p.group_id = ?";
			}
			$items->andWhere ( "(" . implode(" OR ", $groups) . ")", $productgroups);
		}	
        
        $auth = Zend_Auth::getInstance ();
        if( $auth->hasIdentity () ) {
            $logged_user= $auth->getIdentity ();
            $items->whereIn( "o.isp_id", $logged_user['isp_id']);
        }        					
	
		$records = $items->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
		return $records;
	}
		
	/**
	 * RecurringService_datagraph
	 * Create the recurring services group by month
	 * @param unknown_type $services
	 */
	private function RecurringService_datagraph($data, $year){
		$translator = Shineisp_Registry::getInstance ()->Zend_Translate;
		$datagraph = array();
		$total = 0;
		
		for ($i=1; $i<=12; $i++){
			$datagraph[$i]['cost'] = 0;
			$datagraph[$i]['price'] = 0;
			$datagraph[$i]['monthnumber'] = $i;
			$datagraph[$i]['monthname'] = $translator->translate(date("F", mktime(0, 0, 0, $i, 1, date('Y'))));
	
			foreach ($data as $item) {
				if($i == $item['monthnumber'] ){
					$datagraph[$i]['yeardate'] = $item['yeardate'];
					$datagraph[$i]['cost'] += $item['cost'];
					$datagraph[$i]['price'] += $item['price'];
					
					#$datagraph[$i][] = $item;
				}
			}
		}
		
		return $datagraph;
	}	
	
	
	/**
	 * RecurringServiceslist
	 * Create the recurring services list
	 * @param unknown_type $services
	 */
	private function RecurringServiceslist($services){
		$translator = Shineisp_Registry::getInstance ()->Zend_Translate;
		$recurringservices = array();
		
		// Loop for each services found in the database
		foreach ($services as $item){
			
			$item['months'] = !empty($item['months']) ? $item['months'] : 12;
			
			// Now we have to check the length of service. The duration of service is expressed in days.
			$times = round(365 / $item['months']);
			
			if($times > 1){
				// We have to create all the future items
				for ($i = 1; $i <= $times; $i++) {
					if($i >= $item['monthnumber']){
						$item['monthnumber'] = $i;
						$item['monthname'] = $translator->translate(date("F", mktime(0, 0, 0, $i, 1, $item['yeardate'])));
						$recurringservices[] = $item;
					}
				}
			}else{
				$recurringservices[] = $item;
			}
		}
		
		// Delete some array indexes
		for ($i=0;$i<count($recurringservices); $i++){
			unset($recurringservices[$i]['months']);
			unset($recurringservices[$i]['billingcycle']);
		}
		
		return $recurringservices;
	}
	
	/**
	 * Check if the product has been bought from a customer 
	 * 
	 * 
	 * @param $product_id
	 * @return Array
	 */
	public static function CheckIfProductExist($product_id) {
		$total = 0;
		
		if(is_numeric($product_id)){
			$dq = Doctrine_Query::create ()->select ( 'count(*) as total' )->from ( 'OrdersItems oi' )->where ( "product_id = ?", $product_id );
			$items = $dq->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
			$total = $items [0] ['total'];
		}
		
		return $total;
	}
	
	/**
	 * ProductsInOrdersItems
	 * Get all the orders where the product has been selected.
	 * @return array
	 */
	public static function ProductsInOrdersItems($product_id) {
		if (is_numeric ( $product_id )) {
			$records = Doctrine_Query::create ()->select ( 'DATE_FORMAT(oi.date_start, "'.Settings::getMySQLDateFormat('dateformat').'") as date, CONCAT(c.firstname, " ", c.lastname, " - ", c.company) as customer, oi.quantity, oi.order_id as orderid, s.status as status' )
										   ->from ( 'OrdersItems oi' )
										   ->leftJoin( 'oi.Orders o' )
										   ->leftJoin( 'o.Statuses s' )
										   ->leftJoin( 'o.Customers c' )
										   ->where ( "product_id = ?", $product_id )
										   ->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
			return $records;
		}
	}
	
	/**
	 * Save the setup configuration
	 * 
	 * 
	 * @param integer $id OrdersItems::detail_id
	 * @param array $data
	 * @param string $section
	 */
	public static function setNewSetup($id, array $data, $section) {
		
		// Check the main variables
		if(empty($id) || !is_numeric($id) || !is_array($data) || empty($section)){
			return false;
		}
		
		// Get the service setup information
		$service = Doctrine_Query::create ()->select('setup')
										->from ( 'OrdersItems oi' )
										->where ( 'oi.detail_id = ?', $id )
										->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
		if(!empty($service[0])){
			// Create the old array
			$oldSetup = json_decode($service[0]['setup'], true);
			
			// Override the old configuration
			$oldSetup[$section] = $data;
			
			// Create the new configuration
			$newSetup = json_encode($oldSetup);

			// Save the new configuration
			Doctrine_Query::create ()->update ( "OrdersItems oi" )
											->set ( 'oi.setup', "?", $newSetup )
											->where ( "oi.detail_id = ?", $id )
											->execute ();
			return true;
		}
		
		return false;							
		
	}
	
	
	/**
	 * Get the setup configuration
	 * 
	 * 
	 * @return ArrayObject
	 */
	public static function getSetup($id) {
		$setup = "";
		$services = array();
		$panel = Isp::getPanel();
		$records = Doctrine_Query::create ()
										->from ( 'OrdersItems oi' )
										->leftJoin( 'oi.Products p' )
										->where ( 'oi.detail_id = ?', $id )
										->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
		
		foreach ($records as $record) {
			if(!empty($record['Products']['setup'])){
				$setup = $record['Products']['setup'];
				
				// Get the parameters set in the order details (service)
				$params = json_decode($record['parameters'], true);
				if(is_array($params)){

					// Get the list of all the domains
					$domains = OrdersItemsDomains::get_domains($record['detail_id']);

					// We have to get the first domain
					if(!empty($domains[0]['domain'])){
						$params['domain'] = $domains[0]['domain'];
						
						// Get all the var {string} in the xml setup 
						preg_match_all( '/{([^}]+)}/Ui', $setup, $matches );
						foreach ($matches[1] as $parameter) {
							$setup = str_replace("{".$parameter."}", $params[$parameter], $setup);
						}
					}
				}
			}
		}
		
		$xml = simplexml_load_string($setup);		
		$arrSetup = Shineisp_Commons_Utilities::simpleXMLToArray($xml);
		
		return $arrSetup;
	}
	

	/**
	 * Save the setup configuration
	 * 
	 * 
	 * @param integer $id OrdersItems::detail_id
	 * @param array $data
	 * @param string $section
	 */
	public static function set_setup($id, array $data, $section) {
		
		// Check the main variables
		if(empty($id) || !is_numeric($id) || !is_array($data) || empty($section)){
			return false;
		}
		
		// Get the service setup information
		$service = Doctrine_Query::create ()->select('setup')
										->from ( 'OrdersItems oi' )
										->where ( 'oi.detail_id = ?', $id )
										->execute ( array (), Doctrine_Core::HYDRATE_ARRAY );
		if(!empty($service[0])){
			// Create the old array
			$oldSetup = json_decode($service[0]['setup'], true);
			
			// Override the old configuration
			$oldSetup[$section] = $data;
			
			// Create the new configuration
			$newSetup = json_encode($oldSetup);

			// Save the new configuration
			Doctrine_Query::create ()->update ( "OrdersItems oi" )
											->set ( 'oi.setup', "?", $newSetup )
											->where ( "oi.detail_id = ?", $id )
											->execute ();
			return true;
		}
		
		return false;							
		
	}
	
	/***
	 * Get the refund info
	 * @param orderid
	 * @return productid and refundPrice
	 *****/
	public static function getRefundInfo( $orderid ) {
		$service 	= self::getDetail($orderid);
		$product	= $service['Products'];
		$productid	= $product['product_id'];
		
        $productInfo    = Products::getAllInfo($productid);
        $isrefundable   = intval($productInfo['isrefundable']);
        $priceRefund    = 0;
        if( $isrefundable > 0 ) {
    		$pricePaid	= $service['price'];
    		
    		$date		= explode(' ',$service['date_start']);
    		$date		= array_shift($date);
    		list($yyyy,$mm,$dd)	= explode('-',$date);
    		$tsStartService		= mktime(0,0,0,$mm,$dd,$yyyy);
    		
    		$date		= explode(' ',$service['date_end']);
    		$date		= array_shift($date);
    		list($yyyy,$mm,$dd)	= explode('-',$date);
    		$tsEndService	= mktime(0,0,0,$mm,$dd,$yyyy);
    		$tsToday		= mktime(0,0,0,date('m'),date('d'),date('Y'));
    		
    		$dayService		= round( ($tsEndService - $tsStartService) / ( 60*60*24 ) );
    		$priceServiceForDay	= $pricePaid / $dayService;
    		
    		$tsRemain		= 0;
    		$priceRefund	= false;
    		if( $tsEndService > $tsToday ) {
    			$dayRemain		= round( ( $tsEndService - $tsToday ) / (60*60*24) );
    			$priceRefund	= round($priceServiceForDay * $dayRemain,2);
    		}
        }
		
		$result	= array(
			 'productid'	=> $productid
			,'refund'		=> $priceRefund
		);
        
		return $result;					
	}	
	
	/**
	 * Get the list of services
	 * by default it gets only the hosting service
	 * 
	 * @param array $product_types
	 * @return array
	 */
	public static function getServices(array $product_types = array(), array $product_attribute_groups = array()){
		
		$translator = Shineisp_Registry::getInstance ()->Zend_Translate;
		$records['data'] = self::getExpiringServicesByRange(-10, 30, Statuses::id("complete", "orders"), null, $product_types, $product_attribute_groups);

		// adding the index reference
		$records['index'] = "detail_id";
		
		// Create the header table columns
		$records['fields'] = array('product' => array('label' => $translator->translate('Service'), 'type' => 'link', 'link' => array('idx' => 'product_id', 'href' => '/admin/products/edit/id/id/%s')),
									'domain' => array('label' => $translator->translate('Domain'), 'type' => 'link', 'link' => array('idx' => 'domain_id', 'href' => '/admin/domains/edit/id/%s')),
									'expiringdate' => array('label' => $translator->translate('Expiry Date'), 'attributes' => array('class' => 'visible-lg visible-md hidden-xs')),
									'fullname' => array('label' => $translator->translate('Full name'), 'type' => 'link', 'link' => array('idx' => 'id', 'href' => '/admin/customers/edit/id/%s'), 'attributes' => array('class' => 'visible-lg visible-md hidden-xs')),
									'renew' => array('label' => $translator->translate('Auto renewal'), 'attributes' => array('class' => 'visible-lg visible-md hidden-xs')),
									'price' => array('label' => $translator->translate('Due')),
									'days' => array('label' => $translator->translate('Days')));
		
		
		return $records;
	} 
	
	/**
	 * findByUUID
	 * Get a record by uuid
	 * @param $id
	 * @return Doctrine Record
	 */
	public static function findByUUID($uuid) {
		return Doctrine::getTable ( 'OrdersItems' )->findOneBy ( 'uuid', $uuid );
	}




	/**
	 * check if an order item is completed by it's uuid. Used by API
	 */
	public static function checkIfCompletedByUUID($uuid) {
		if ( empty($uuid) ) {
			return false;
		}
		
		$OrderItem = self::findByUUID($uuid);
		if ( $OrderItem && isset($OrderItem->status_id) && $OrderItem->status_id == Statuses::id("complete", "orders") ) {
			return true;
		}
		
		return false;
	}


	/**
	 * activate
	 * Activate an order item
	 * @param $orderItemId
	 * @return true|false
	 */
	public static function activate($orderItemId) {
        Shineisp_Commons_Utilities::log(__METHOD__ . " - Activate Detail ID #".$orderItemId);
        
		$orderItemId = intval($orderItemId);
		if ( $orderItemId < 1 ) {
			// missing order item id from arguments
			return false;
		}
		
		// Get OrderItem
		$ordersItem = self::find($orderItemId);
		$ordersItem = $ordersItem->toArray();
        $OrderItem  = array_shift($ordersItem);
		if ( !$OrderItem ) {
			// order item not found
			return false;
		}

		// Get customerId related to this order
		$customerId = Orders::getCustomer($OrderItem['order_id']);
        
		/*
		 * START ACTIVATIONS CODE
		 */
		 
        $upgrade        = Orders::isUpgrade($OrderItem['order_id']);
        $upgrade_uuid   = false; 
        if( $upgrade !== false ) {
            $orderItem  = OrdersItems::getDetail($upgrade);
            Shineisp_Commons_Utilities::logs ( __METHOD__ . " - OITEM::".print_r($orderItem,true) );
            $oldOrderId = $orderItem['order_id'];

            Orders::set_status ( $oldOrderId, Statuses::id("changed", "orders") ); // Close the old order ::status changed
            OrdersItems::set_status($upgrade, Statuses::id("changed", "orders"));
            
            $upgrade_uuid   = $orderItem['uuid'];
            // log
            Shineisp_Commons_Utilities::logs ( __METHOD__ .  " - Order changed from #".$oldOrderId." to #".$OrderItem['order_id'] );
        } 		 

		if ( empty($OrderItem['parameters']) ) {
			Shineisp_Commons_Utilities::logs (__METHOD__ . " - Order items setup parameters empty" );
			return false;
		}
		
		// Is this an hosting? execute panel task
		// TODO: this should call an hook or an even bound to the panel
		if ( isset($OrderItem['Products']) && isset($OrderItem['Products']['type']) && $OrderItem['Products']['type'] == 'hosting' ) {
			Shineisp_Commons_Utilities::logs ( __METHOD__ . " Hosting task queued");
			
			PanelsActions::AddTask($customerId, $OrderItem['detail_id'], "fullProfile", $OrderItem['parameters']);

			return true;
		}
		
		// Is this a domain? execute domain task
		if ( isset($OrderItem['tld_id']) && intval($OrderItem['tld_id']) > 0 ) {
			
			$parameters = json_decode($OrderItem['parameters']);	
				

			if ( empty($parameters->domain) ) {
				Shineisp_Commons_Utilities::logs (  __METHOD__ . " Domain has been not set in the order detail #$orderItemId" );	
				return false;
			}			
			
			// Create the domain record
			$domain = Domains::Create($parameters->domain, intval($OrderItem['tld_id']), intval($customerId), $orderItemId);
			
			// Create the domain task
			if(!empty($parameters->domain) && !empty($parameters->action)){
				$domains[] = array('domain' => $parameters->domain, 'action' => $parameters->action);
				$retval = DomainsTasks::AddTasks ($domains);
				Shineisp_Commons_Utilities::logs (  __METHOD__ . " Domain task queued" );
			}
			 
			return $retval;
		}

	}
}